
# SunEnergyXT B2B 门户系统详细需求规格说明书 (PRD) v2.1

## 1. 文档概述
本文档基于 `SunEnergyXT` 工程源码反向生成，旨在详细描述系统的功能模块、界面布局、字段定义及权限逻辑。文档采用“界面线框图 + 字段映射表”的形式，确保开发与测试人员对需求理解的一致性。

---

## 2. 角色权限体系 (RBAC) 核心定义

系统设计了四种核心角色，权限控制贯穿 UI 展示与业务逻辑。

### 2.1 角色定义表

| 角色代码 (Enum) | 中文名称 | 归属方 | 核心职责 |
| :--- | :--- | :--- | :--- |
| `SUPER_ADMIN` | 超级管理员 | **总部 (HQ)** | 系统上帝视角。管理内部账号、所有合作伙伴、所有工单。拥有最高操作权限。 |
| `INTERNAL_SALES`| 内部销售 | **总部 (HQ)** | 业务负责人。管理其负责的合作伙伴，创建工单，处理工单的最终复审。 |
| `PARTNER_ADMIN` | 合作伙伴管理员 | **外部 (Partner)** | 经销商/安装商老板。管理其名下的安装工，接收总部派发的工单并二次指派，负责内部质量审核。 |
| `PARTNER_STAFF` | 安装工 | **总部 或 外部** | 一线执行者。仅能查看和处理指派给自己的具体工单。 |

### 2.2 安装工的一致性逻辑
**重要原则**：系统中存在“总部安装工”和“合作伙伴安装工”。
*   **身份一致性**：两者在代码中角色均为 `PARTNER_STAFF`。
*   **权限一致性**：两者在工单处理流程（开始、完成）中的操作权限完全一致。
*   **数据隔离**：
    *   总部安装工 (`companyId = 'c0'`)：只能被总部销售/超管指派。
    *   伙伴安装工 (`companyId = 'cX'`)：只能被其所属公司的管理员指派。

---

## 3. 全局布局与导航 (Layout)

### 3.1 侧边栏导航菜单
系统根据登录角色的不同，动态渲染侧边栏菜单。

**UI 结构示意:**
```text
+-----------------------------+
| [1] SunEnergyXT (Logo)      |
+-----------------------------+
| [2] 当前用户角色卡片         |
|     (图标 + 角色名)          |
+-----------------------------+
| 菜单区:                     |
| [3] 工作台 (Dashboard)      |
| [4] 内部账号管理 (仅超管)    |
| [5] 合作伙伴管理 (仅HQ)      |
| [6] 安装工管理 (除安装工外)  |
| [7] 产品中心                |
| [8] 服务支持 (Tickets)      |
| [9] 公司信息                |
+-----------------------------+
| [10] 底部用户信息 & 退出     |
+-----------------------------+
```

**字段与逻辑说明:**

| 编号 | 模块/字段 | 可见性 (RBAC) | 交互/逻辑说明 |
| :--- | :--- | :--- | :--- |
| [2] | 角色卡片 | 全员 | 不同角色显示不同背景色：<br>🔴超管 🟣销售 🔵伙伴 🟢安装工 |
| [4] | 内部账号 | `SUPER_ADMIN` | 仅超管可见，用于管理销售账号。 |
| [5] | 伙伴管理 | `SUPER_ADMIN`<br>`INTERNAL_SALES` | 总部人员可见，用于审批注册和管理渠道商。 |
| [6] | 安装工管理 | `SUPER_ADMIN`<br>`INTERNAL_SALES`<br>`PARTNER_ADMIN` | **上下文敏感**：<br>- 总部人员进入：管理总部直属安装工。<br>- 伙伴管理员进入：管理该伙伴名下的安装工。<br>- 安装工不可见。 |

---

## 4. 核心功能模块详解

### 4.1 工作台 (Dashboard)

**UI 结构示意:**
```text
+---------------------------------------------------------------+
| [1] 欢迎 Banner (渐变背景)                                    |
|     "欢迎回来, [User Name]"                                   |
|     [按钮A: 浏览产品库]  [按钮B: 查看我的工单]                |
+---------------------------------------------------------------+
|                                                               |
| +-----------------------+    +------------------------------+ |
| | [2] 统计卡片 - 进行中  |    | [4] 内部通知 (Tiles)         | |
| |     (数量 + 图标)     |    | - [Tag] 标题 [日期]          | |
| +-----------------------+    | - [Tag] 标题 [日期]          | |
|                              +------------------------------+ |
| +-----------------------+                                     |
| | [3] 统计卡片 - 已完成  |    +------------------------------+ |
| |     (数量 + 图标)     |    | [5] 行业新闻 (List)          | |
| +-----------------------+    | - 新闻标题 [外链图标]        | |
|                              | - 新闻标题 [外链图标]        | |
|                              +------------------------------+ |
+---------------------------------------------------------------+
```

**详细说明:**

1.  **[1] 欢迎区**: 针对所有用户显示个性化问候。
2.  **[2][3] 统计卡片**:
    *   **数据来源**: 基于 `Ticket` 表。
    *   **数据隔离**:
        *   超管：看到全平台所有工单统计。
        *   销售：看到自己负责的工单统计。
        *   伙伴：看到分发给自己公司的工单统计。
        *   安装工：看到指派给自己的工单统计。
3.  **[4] 内部通知**: 显示 `type: 'alert' | 'update'` 的通知，通常用于系统维护公告。
4.  **[5] 行业新闻**: 显示 `type: 'news'` 的通知，点击跳转外部链接。

---

### 4.2 服务支持 (工单系统) - 列表页

**UI 结构示意:**
```text
+---------------------------------------------------------------+
| [1] 标题: 服务支持中心       [2] 按钮: +新建工单 (安装工不可见)|
+---------------------------------------------------------------+
| [3] 搜索栏: [ 🔍 搜索单号/标题/SLN... ]   [4] 状态筛选: [全部 v]|
+---------------------------------------------------------------+
| [5] 数据表格                                                  |
| ID | 标题/客户 | 负责方 | 状态 | 最后更新 | 操作            |
| -- | --------- | ------ | ---- | -------- | ----            |
| #1 | ...       | ...    | ...  | ...      | [处理]          |
| ...                                                           |
+---------------------------------------------------------------+
```

**逻辑说明:**
*   **[2] 新建按钮**: `PARTNER_STAFF` (安装工) **不可见**。安装工只能被动接收任务，不能主动发起工单。
*   **[5] 数据表格**:
    *   **负责方列**: 显示 `assignedToCompanyId` (公司名) 和 `assignedToUserId` (安装工名)。
    *   **状态列**: 使用不同颜色的徽章 (`StatusBadge`) 展示。

---

### 4.3 服务支持 - 新建工单页 (Create Ticket)

这是业务发起的入口，表单逻辑较复杂。

**UI 结构示意:**
```text
+---------------------------------------------------------------+
| 标题: 创建服务工单                        [X] 取消            |
+---------------------------------------------------------------+
| [1] 指派销售负责人 (仅超管可见, 下拉选框)                     |
+---------------------------------------------------------------+
| [2] 客户姓名 (文本输入)                                       |
+---------------------------------------------------------------+
| [3] 产品型号 (下拉选择)      | [4] 序列号 SLN (文本输入)      |
+------------------------------+--------------------------------+
| [5] 工单标题 (文本输入)                                       |
+---------------------------------------------------------------+
| [6] 服务类型 (多选 Checkbox):  [ ] 新设备安装   [ ] 旧设备拆除 |
+---------------------------------------------------------------+
| [7] 详细描述 (多行文本域)                                     |
+---------------------------------------------------------------+
|                                       [取消] [8] 提交工单     |
+---------------------------------------------------------------+
```

**字段详细定义:**

| 编号 | 字段名 | 必填 | 类型 | 逻辑与限制 |
| :--- | :--- | :--- | :--- | :--- |
| [1] | `salesOwnerId` | **是** | Dropdown | **仅 `SUPER_ADMIN` 可见**。超管创建工单时，必须指定该工单归属于哪个内部销售人员管理。其他角色创建时，该字段自动设为当前用户或空。 |
| [2] | `customerName` | 是 | Text | 终端客户的姓名，用于搜索。 |
| [3] | `productId` | 是 | Dropdown | 数据源来自 `Products` 表。如果从产品中心点击“技术支持”进来，此项会自动预填。 |
| [4] | `sln` | 是 | Text | 设备的唯一序列号。 |
| [5] | `title` | 是 | Text | 简短的问题摘要。 |
| [6] | `serviceTypes` | 是 | Checkbox[] | **多选数组**。用户可同时选择“安装”和“拆除”。代码中存储为 `string[]`。 |
| [7] | `description`| 是 | Textarea | 详细的问题描述或安装环境备注。 |

---

### 4.4 服务支持 - 工单详情页 (Ticket Detail) - **核心页面**

此页面分为左右两栏结构。

**UI 结构示意:**
```text
< 返回列表   [删除工单(仅特定权限)]
+-------------------------------------+  +-------------------------------------+
| 左栏：状态与信息                     |  | 右栏：沟通记录                      |
+-------------------------------------+  +-------------------------------------+
| [1] 头部信息卡                      |  | [6] 消息列表区                      |
|    - 工单号 / 标题 / 客户名          |  |    - 对方消息 (左, 白底)            |
|    - [状态徽章]                     |  |    - 我方消息 (右, 蓝底)            |
|                                     |  |    - 系统消息 (居中, 灰色)          |
| [2] 流程操作区 (动态变化)            |  |                                     |
|    [分配伙伴] / [派单] / [开始处理]  |  |                                     |
|    (根据状态和角色显示不同按钮)      |  |                                     |
|                                     |  +-------------------------------------+
| [3] 指派信息区                      |  | [7] 发送输入区                      |
|    - 合作伙伴: [公司名]             |  | +---------------------------------+ |
|    - 安装工:   [人名]               |  | | 输入框...                       | |
|    - 负责销售: [人名]               |  | +---------------------------------+ |
|                                     |  |                     [发送]        |
+-------------------------------------+  +-------------------------------------+
| [4] 详细信息卡                      |
|    - 任务描述 (灰底框)              |
|    - SLN / 创建时间                 |
|    - 服务类型 (Tags)                |
+-------------------------------------+
| [5] 操作日志 (Logs)                 |
|    o [时间] [动作] [操作人+角色]     |
|    |                                |
|    o [时间] [动作] ...              |
+-------------------------------------+
```

**模块详细说明:**

#### [2] 流程操作区 (Lifecycle Actions) - 逻辑极其复杂

此区域按钮根据工单状态 (`status`) 和当前用户角色 (`role`) 动态渲染。

1.  **待分配 (`PENDING_ASSIGN`)**:
    *   **可见按钮**: `[分配给合作伙伴或总部]`
    *   **操作权**: `SUPER_ADMIN`, `INTERNAL_SALES`
    *   **行为**: 弹出模态框，选择 `Company`。状态变更为 `PENDING_DISPATCH`。

2.  **待派单 (`PENDING_DISPATCH`)**:
    *   **可见按钮**: `[指派安装工]`
    *   **操作权**:
        *   `PARTNER_ADMIN` (如果工单分给了该伙伴)。
        *   `INTERNAL_SALES`/`SUPER_ADMIN` (如果工单分给了总部 `c0`)。
    *   **行为**: 弹出模态框，选择该主体下的 `User` (Role=`PARTNER_STAFF`)。状态变更为 `PENDING_PROCESS`。

3.  **待处理 (`PENDING_PROCESS`)**:
    *   **可见按钮**: `[开始处理]`
    *   **操作权**:
        *   `PARTNER_STAFF` (被指派的那个安装工)。
        *   **权限覆盖**: `PARTNER_ADMIN` (伙伴老板) 或 `INTERNAL_SALES`/`SUPER_ADMIN` 也可以点击此按钮代为操作。
    *   **行为**: 状态变更为 `IN_PROGRESS`。日志记录操作人。

4.  **处理中 (`IN_PROGRESS`)**:
    *   **可见按钮**: `[完成处理 & 提交审核]`
    *   **操作权**: 同上（安装工本人 或 上级管理员覆盖）。
    *   **行为**: 状态变更为 `PENDING_INTERNAL_AUDIT`。

5.  **待内部审核 (`PENDING_INTERNAL_AUDIT`)**:
    *   **可见按钮**: `[驳回]` `[审核通过]`
    *   **操作权**: `PARTNER_ADMIN` (伙伴单) 或 `INTERNAL_SALES` (HQ单)。
    *   **逻辑分支**:
        *   如果是伙伴自建工单 或 总部自营工单 -> 点击通过后直接 `CLOSED` (归档)。
        *   如果是销售指派给伙伴的工单 -> 点击通过后变为 `PENDING_FINAL_REVIEW` (提交给销售复审)。

6.  **待复审 (`PENDING_FINAL_REVIEW`)**:
    *   **可见按钮**: `[驳回]` `[确认完结 (关闭工单)]`
    *   **操作权**: `INTERNAL_SALES`, `SUPER_ADMIN`。
    *   **行为**: 最终关闭工单。

#### [5] 操作日志 (Operation Logs)
*   **字段**: `timestamp`, `action` (如"创建工单"), `operatorName`, `operatorRole`。
*   **展示**: 倒序排列（最新的在最上），包含时间轴样式。
*   **作用**: 审计追踪。例如，如果销售代安装工点击了“开始处理”，日志会明确显示操作人是销售，而非安装工。

#### [7] 消息发送区 (Message Input)
*   **注意**: 内部备注功能已移除，所有消息对相关人员全员可见。

---

### 4.5 合作伙伴管理 (Partner Management)
*仅 HQ 可见*

**UI 结构示意:**
```text
+-----------------------------------+
| [Tab 1: 已签约伙伴]  [Tab 2: 注册申请] |
+-----------------------------------+
|                                   |
| 表格列:                           |
| 公司名称 | 区域 | 管理员 | 电话 | 操作 |
| ------- | ---- | ------ | ---- | ---- |
| 快修...  | 上海 | Ian    | 138..| [✎][🔒][🗑] |
+-----------------------------------+
```

**操作按钮说明:**
*   `[✎] 编辑`: 修改公司基本信息（名称、区域、电话）。
*   `[🔒] 重置密码`: 强制重置该合作伙伴管理员 (`PARTNER_ADMIN`) 的登录密码。
*   `[🗑] 删除`:
    *   **逻辑**: 物理删除公司及该公司的所有用户。
    *   **工单回退机制**: 如果该公司有未关闭的工单，系统会自动将这些工单的 `assignedToCompanyId` 置空，状态重置为 `PENDING_ASSIGN`，并退回到总部列表，防止工单丢失。

---

### 4.6 安装工管理 (Installer Management)
*全员可见（除安装工外），内容上下文相关*

**UI 结构示意:**
```text
+-----------------------------------------+
| 标题: [总部/安装团队]管理      [+ 添加安装工]|
+-----------------------------------------+
| 表格列:                                 |
| 姓名 | 邮箱(账号) | 状态 | 操作           |
| ---- | ---------- | ---- | ----           |
| Sam  | sam@...    | 正常 | [🔒 重置] [🗑] |
+-----------------------------------------+
```

**上下文逻辑:**
*   **总部人员 (Sales/Admin) 访问**: 看到的是 `companyId = 'c0'` 的用户（总部安装队）。
*   **伙伴管理员 (Partner Admin) 访问**: 看到的是 `companyId = [自己的ID]` 的用户（自己的员工）。
*   **数据隔离**: 伙伴A 绝对看不到 伙伴B 的安装工。

---

## 5. 附件：数据模型简表 (Schema Reference)

仅列出关键逻辑字段。

### Ticket (工单)
```typescript
interface Ticket {
  id: string;
  status: TicketStatus; // 核心状态机
  
  // 归属与创建
  createdBy: string;
  companyId: string;    // 工单最初的所有者公司
  salesOwnerId?: string; // 总部负责的销售 (数据权限关键)

  // 流程流转
  upstreamCompanyId?: string; // 上游派发方 (通常是HQ)
  assignedToCompanyId?: string; // 当前接单公司
  assignedToUserId?: string;    // 当前接单安装工

  // 业务数据
  serviceTypes: string[]; // 服务类型数组
  logs: TicketLog[];      // 操作日志
  messages: Message[];    // 聊天记录
}
```

### TicketLog (日志)
```typescript
interface TicketLog {
  id: string;
  action: string;      // 动作描述
  operatorId: string;  // 操作人ID
  operatorName: string;// 操作人快照
  operatorRole: UserRole; // 角色快照 (用于显示 (超管) 等后缀)
  timestamp: Date;
}
```
